{% extends "base.html" %}
{% block content %}
<style>
  .workout-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }
  .workout-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  }
  .form-label {
    font-weight: 600;
  }
  .btn-outline-success, .btn-outline-danger, .btn-outline-secondary {
    border-radius: 8px;
    padding: 2px 10px;
  }
  input.form-control {
    border-radius: 8px;
  }
  .day-section {
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }
  .input-group .form-control {
    border-radius: 8px 0 0 8px;
  }
  .input-group button {
    border-radius: 0;
  }
</style>

<div class="container mt-4 mb-5">
  <h2 class="text-center mb-4">ğŸ’ª Set Weekly Workout Plan</h2>

  <div class="workout-card">
    <form method="post" id="workout-form">
      {% csrf_token %}

      {% for day, title, exercises in workout_data %}
        <div class="day-section">
          <label class="form-label d-flex justify-content-between align-items-center">
            <span>{{ day }}</span>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="addExerciseField('{{ day }}')">â• Add Exercise</button>
          </label>

          <!-- Editable title -->
          <div class="mb-2">
            <input type="text" style="font-weight: 600;font-size: large;" name="{{ day|slugify }}_title" value="{{ title }}" 
                   placeholder="e.g. Glute Growth Focus" class="form-control mb-2" />
          </div>

          <div id="{{ day|slugify }}-container">
            {% for exercise in exercises %}
              <div class="input-group mb-2 animate__animated animate__fadeIn">
                <input type="text" name="{{ day|slugify }}" class="form-control" value="{{ exercise }}" readonly>

                <!-- Edit button -->
                <button type="button" class="btn btn-outline-secondary edit-exercise-btn" title="Edit"
                        data-day="{{ day }}" data-original="{{ exercise }}">âœï¸</button>

                <!-- Delete button -->
                <button type="button" class="btn btn-outline-danger delete-exercise-btn"
                        data-day="{{ day }}" data-exercise="{{ exercise }}">ğŸ—‘</button>
              </div>
            {% empty %}
              <!-- No exercises -->
            {% endfor %}
          </div>
        </div>
      {% endfor %}

      <button type="submit" class="btn btn-primary w-100 mt-3 shadow-sm">ğŸ’¾ Save Workout Plan</button>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // ğŸ—‘ DELETE workout
  document.querySelectorAll(".delete-exercise-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const day = btn.dataset.day;
      const exercise = btn.dataset.exercise;

      if (confirm(`Delete "${exercise}" from ${day}'s workout plan?`)) {
        fetch("{% url 'delete_workout_item' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body: new URLSearchParams({ day, exercise }),
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const wrapper = btn.closest(".input-group");
            wrapper.classList.add("animate__fadeOut");
            setTimeout(() => wrapper.remove(), 300);
          } else {
            alert("Error: " + (data.error || "Unable to delete item."));
          }
        })
        .catch(() => alert("Something went wrong!"));
      }
    });
  });

  // âœï¸ EDIT workout inline
  document.querySelectorAll(".edit-exercise-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const input = btn.closest(".input-group").querySelector("input");
      const originalValue = btn.dataset.original;
      const day = btn.dataset.day;

      if (btn.textContent === "âœï¸") {
        // Switch to edit mode
        input.removeAttribute("readonly");
        input.focus();
        btn.textContent = "âœ…";
        btn.classList.remove("btn-outline-secondary");
        btn.classList.add("btn-outline-success");
      } else {
        // Save edited value
        const newValue = input.value.trim();
        if (newValue && newValue !== originalValue) {
          fetch("{% url 'delete_workout_item' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({
              day: day,
              exercise: originalValue
            }),
          }).then(() => {
            // Add updated exercise (simulate replace)
            fetch("", { method: "POST" }); // optional, full save handled via form submit
          });
          btn.dataset.original = newValue;
        }
        input.setAttribute("readonly", true);
        btn.textContent = "âœï¸";
        btn.classList.remove("btn-outline-success");
        btn.classList.add("btn-outline-secondary");
      }
    });
  });

  // â• ADD new exercise dynamically
  window.addExerciseField = function(day) {
    const containerId = day.toLowerCase().replace(/ /g, '-') + '-container';
    const container = document.getElementById(containerId);

    const wrapper = document.createElement("div");
    wrapper.classList.add("input-group", "mb-2", "animate__animated", "animate__fadeIn");

    const input = document.createElement("input");
    input.type = "text";
    input.name = day.toLowerCase().replace(/ /g, '-');
    input.placeholder = "Enter exercise name";
    input.classList.add("form-control");

    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.classList.add("btn", "btn-outline-secondary");
    editBtn.innerHTML = "âœï¸";
    editBtn.addEventListener("click", () => {
      input.removeAttribute("readonly");
      input.focus();
    });

    const deleteBtn = document.createElement("button");
    deleteBtn.type = "button";
    deleteBtn.classList.add("btn", "btn-outline-danger");
    deleteBtn.innerHTML = "ğŸ—‘";
    deleteBtn.addEventListener("click", () => wrapper.remove());

    wrapper.appendChild(input);
    wrapper.appendChild(editBtn);
    wrapper.appendChild(deleteBtn);
    container.appendChild(wrapper);
    input.focus();
  };
});
</script>
{% endblock %}
