{% extends "base.html" %}
{% block content %}
<style>
  .diet-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }
  .diet-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  }
  .form-label {
    font-weight: 600;
    font-size: 1.1rem;
  }
  .btn-outline-primary, .btn-outline-danger, .btn-outline-secondary {
    border-radius: 8px;
    padding: 2px 10px;
  }
  input.form-control {
    border-radius: 8px;
  }
  .meal-section {
    margin-bottom: 25px;
  }
  .input-group .form-control {
    border-radius: 8px 0 0 8px;
  }
  .input-group button {
    border-radius: 0;
  }
</style>

<div class="container mt-4 mb-5">
  <h2 class="text-center mb-4">ğŸ½ï¸ Set Your Daily Diet Plan</h2>

  <div class="diet-card">
    <form method="post" id="dietForm">
      {% csrf_token %}

      {% for meal, food_string in meal_data %}
        <div class="meal-section">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">{{ meal }}</label>
            <button type="button" class="btn btn-sm btn-outline-primary add-btn" data-meal="{{ meal|slugify }}">â• Add</button>
          </div>

          <div id="{{ meal|slugify }}-group">
            {% with food_string|default:'' as food_line %}
              {% for item in food_line.splitlines %}
                {% if item %}
                  <div class="input-group mb-2 animate__animated animate__fadeIn">
                    <input type="text" name="{{ meal|slugify }}_item_{{ forloop.counter }}" 
                           class="form-control" value="{{ item }}" readonly>

                    <button type="button" class="btn btn-outline-secondary edit-btn"
                            data-meal="{{ meal }}" data-original="{{ item }}">âœï¸</button>

                    <button type="button" class="btn btn-outline-danger remove-btn"
                            data-meal="{{ meal }}" data-food="{{ item }}">ğŸ—‘</button>
                  </div>
                {% endif %}
              {% endfor %}
            {% endwith %}
          </div>
        </div>
      {% endfor %}

      <button type="submit" class="btn btn-primary w-100 mt-3 shadow-sm">ğŸ’¾ Save Diet Plan</button>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // ğŸ—‘ DELETE food item from DB via AJAX
  document.querySelectorAll(".remove-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const meal = btn.dataset.meal;
      const food = btn.dataset.food;

      if (confirm(`Delete "${food}" from ${meal}?`)) {
        fetch("{% url 'delete_diet_item' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body: new URLSearchParams({ meal_time: meal, food_item: food }),
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const wrapper = btn.closest(".input-group");
            wrapper.classList.add("animate__fadeOut");
            setTimeout(() => wrapper.remove(), 300);
          } else {
            alert("Error: " + (data.error || "Unable to delete item."));
          }
        })
        .catch(() => alert("Something went wrong!"));
      }
    });
  });

  // âœï¸ EDIT food item inline
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const input = btn.closest(".input-group").querySelector("input");
      const meal = btn.dataset.meal;
      const originalValue = btn.dataset.original;

      if (btn.textContent === "âœï¸") {
        // Switch to edit mode
        input.removeAttribute("readonly");
        input.focus();
        btn.textContent = "âœ…";
        btn.classList.remove("btn-outline-secondary");
        btn.classList.add("btn-outline-success");
      } else {
        // Save edited value
        const newValue = input.value.trim();
        if (newValue && newValue !== originalValue) {
          // Delete old + re-add new
          fetch("{% url 'delete_diet_item' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({
              meal_time: meal,
              food_item: originalValue
            }),
          }).then(() => {
            // Add new entry (temporary local update, DB updates on Save)
            btn.dataset.original = newValue;
          });
        }
        input.setAttribute("readonly", true);
        btn.textContent = "âœï¸";
        btn.classList.remove("btn-outline-success");
        btn.classList.add("btn-outline-secondary");
      }
    });
  });

  // â• ADD new item dynamically
  document.querySelectorAll(".add-btn").forEach(button => {
    button.addEventListener("click", () => {
      const mealSlug = button.dataset.meal;
      const container = document.getElementById(`${mealSlug}-group`);
      const count = container.querySelectorAll(".input-group").length + 1;

      const wrapper = document.createElement("div");
      wrapper.classList.add("input-group", "mb-2", "animate__animated", "animate__fadeIn");

      const input = document.createElement("input");
      input.type = "text";
      input.name = `${mealSlug}_item_${count}`;
      input.placeholder = `Food item for ${mealSlug.replace('-', ' ')}`;
      input.classList.add("form-control");

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.classList.add("btn", "btn-outline-secondary");
      editBtn.innerHTML = "âœï¸";
      editBtn.addEventListener("click", () => {
        input.removeAttribute("readonly");
        input.focus();
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.classList.add("btn", "btn-outline-danger");
      deleteBtn.innerHTML = "ğŸ—‘";
      deleteBtn.addEventListener("click", () => wrapper.remove());

      wrapper.appendChild(input);
      wrapper.appendChild(editBtn);
      wrapper.appendChild(deleteBtn);
      container.appendChild(wrapper);
      input.focus();
    });
  });
});
</script>
{% endblock %}
