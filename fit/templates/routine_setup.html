{% extends "base.html" %}
{% block content %}
<style>
  #routineSuggestions {
    background: #f9fafb;
    border: 2px dashed #6c757d;
    transition: 0.3s ease;
  }
  #routineSuggestions strong {
    color: #212529;
  }
  #routineSuggestions input[type=checkbox] {
    transform: scale(1.1);
    margin-right: 6px;
  }
</style>

<div class="container mt-4">
  <h3 class="mb-3">üïí Routine Setup</h3>

  <!-- üíæ Add/Edit Routine Form -->
  <form method="POST" class="card p-3 mb-4">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" name="title" class="form-control" placeholder="e.g. Morning Routine" required>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label">Start Time</label>
        <input type="time" name="start_time" class="form-control" required>
      </div>
      <div class="col">
        <label class="form-label">End Time</label>
        <input type="time" name="end_time" class="form-control" required>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Days of Week</label>
      <div class="d-flex flex-wrap gap-2">
        {% for day in weekdays %}
          <label class="form-check-label border rounded px-3 py-1">
            <input type="checkbox" name="days" value="{{ day }}"> {{ day }}
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- ü•ó Diet Section -->
    <div class="mb-3">
      <label class="form-label">Attach Diet Plan (optional)</label>
      <select name="diet_day" class="form-select mb-2">
        <option value="">-- Select Day --</option>
        {% for d in weekdays %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
      <textarea name="diet_items" class="form-control" rows="3"
                placeholder="Enter diet items or auto-fill from selected day"></textarea>
      <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="loadDietBtn">Load Diet from Day</button>
    </div>

    <!-- üèãÔ∏è Workout Section -->
    <div class="mb-3">
      <label class="form-label">Attach Workout Plan (optional)</label>
      <select name="workout_day" class="form-select mb-2">
        <option value="">-- Select Day --</option>
        {% for d in weekdays %}
          <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
      </select>
      <textarea name="workout_items" class="form-control" rows="3"
                placeholder="Enter workout exercises or auto-fill from selected day"></textarea>
      <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="loadWorkoutBtn">Load Workout from Day</button>
    </div>

    <button type="submit" class="btn btn-success w-100 mt-3">üíæ Save Routine</button>
  </form>
</div>
<h5 class="mt-4 mb-3">üìã Saved Routines</h5>
{% if routines %}
  <ul class="list-group">
    {% for r in routines %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ r.title }}</strong><br>
            <small class="text-muted">
              {{ r.start_time|time:"h:i A" }} - {{ r.end_time|time:"h:i A" }} <br>
              Days: {{ r.days|join:", " }}
            </small>
            {% if r.description %}
              <pre class="mt-2 text-muted" style="white-space: pre-wrap;">{{ r.description }}</pre>
            {% endif %}
          </div>
          <div class="d-flex gap-2">
            <button 
              type="button"
              class="btn btn-sm btn-warning edit-btn"
              data-id="{{ r.id }}"
              data-title="{{ r.title }}"
              data-start="{{ r.start_time }}"
              data-end="{{ r.end_time }}"
              data-days="{{ r.days|join:',' }}">
              ‚úèÔ∏è Edit
            </button>

            <form method="POST" action="{% url 'delete_routine' r.id %}"
                  onsubmit="return confirm('Are you sure you want to delete this routine?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger">üóë Delete</button>
            </form>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">No routines added yet.</p>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dietData = {{ diet_data|safe }};
  const workoutData = {{ workout_data|safe }};

  const dietSelect = document.querySelector("[name='diet_day']");
  const workoutSelect = document.querySelector("[name='workout_day']");
  const dietTextarea = document.querySelector("[name='diet_items']");
  const workoutTextarea = document.querySelector("[name='workout_items']");
  const loadDietBtn = document.getElementById("loadDietBtn");
  const loadWorkoutBtn = document.getElementById("loadWorkoutBtn");

  loadDietBtn.addEventListener("click", () => {
    const day = dietSelect.value;
    if (!day) return alert("Please select a day first.");
    const meals = dietData[day];
    if (!meals) return alert("No diet plan found for this day.");
    let text = "";
    for (const [meal, foods] of Object.entries(meals)) {
      text += `${meal}: ${foods.join(", ")}\n`;
    }
    dietTextarea.value = text.trim();
  });

  loadWorkoutBtn.addEventListener("click", () => {
    const day = workoutSelect.value;
    if (!day) return alert("Please select a day first.");
    const w = workoutData[day];
    if (!w) return alert("No workout plan found for this day.");
    workoutTextarea.value = `${w.title}:\n${w.exercises.join("\n")}`;
  });
});
</script>
{% endblock %}
