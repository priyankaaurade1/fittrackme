{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
  body { background: #f7fafc; }
  h2,h5 { font-weight: 700; }
  .card-analytic {
    border: none;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    transition: transform 0.25s ease;
  }
  .card-analytic:hover { transform: translateY(-4px); }
  .progress-ring { width: 100px; height: 100px; position: relative; }
  .progress-ring svg { transform: rotate(-90deg); }
  .progress-ring circle { fill: none; stroke-width: 10; stroke-linecap: round; }
  .progress-ring .bg { stroke: #eee; }
  .progress-ring .progress { stroke: url(#grad1); transition: stroke-dashoffset 1s ease; }
  .progress-value {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-weight:700; font-size:1.2rem;
  }
  .chart-card canvas { height:220px!important; }
</style>

<div class="container mt-4 mb-5">
  <h2 class="text-center mb-4">üìà Your Health Dashboard</h2>

  <!-- Range Selector -->
  <form method="get" class="text-center mb-4">
    <select name="range" class="form-select d-inline w-auto fw-semibold" onchange="this.form.submit()">
      <option value="day" {% if selected_range == 'day' %}selected{% endif %}>Today</option>
      <option value="week" {% if selected_range == 'week' %}selected{% endif %}>This Week</option>
      <option value="month" {% if selected_range == 'month' %}selected{% endif %}>This Month</option>
      <option value="year" {% if selected_range == 'year' %}selected{% endif %}>This Year</option>
    </select>
  </form>
  <!-- üß† Performance Insights -->
  <div class="mt-5 animate__animated animate__fadeInUp">
    <h4 class="text-center mb-3">üåü Performance Insights</h4>
    <div class="card shadow-sm border-0 p-4 bg-light">
      {% for insight in insights %}
        <div class="d-flex align-items-start mb-2">
          <span class="me-2 fs-5">‚û°Ô∏è</span>
          <p class="mb-0">{{ insight }}</p>
        </div>
      {% empty %}
        <p class="text-muted mb-0 text-center">No insights available for this period.</p>
      {% endfor %}
    </div>
  </div>
  <!-- Overview Cards -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-md-4">
      <div class="card card-analytic p-3 bg-gradient bg-light animate__animated animate__fadeInUp">
        <h5>üçΩÔ∏è Meals</h5>
        <div class="progress-ring mx-auto mt-2">
          <svg width="100" height="100" data-percent="{{ meal_completion_percent }}">
            <defs>
              <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#6dd5ed"/><stop offset="100%" style="stop-color:#2193b0"/>
              </linearGradient>
            </defs>
            <circle class="bg" cx="50" cy="50" r="45"/>
            <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="282" stroke-dashoffset="282"/>
          </svg>
          <span class="progress-value">{{ meal_completion_percent }}%</span>
        </div>
        <p class="mt-2 small text-muted">{{ meal_completed_days }} of {{ total_days }} days</p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card card-analytic p-3 bg-gradient bg-light animate__animated animate__fadeInUp animate__delay-1s">
        <h5>üí™ Workouts</h5>
        <div class="progress-ring mx-auto mt-2">
          <svg width="100" height="100" data-percent="{{ workout_completion_percent }}">
            <circle class="bg" cx="50" cy="50" r="45"/>
            <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="282" stroke-dashoffset="282"/>
          </svg>
          <span class="progress-value">{{ workout_completion_percent }}%</span>
        </div>
        <p class="mt-2 small text-muted">{{ workout_days }} of {{ total_days }} days</p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card card-analytic p-3 bg-gradient bg-light animate__animated animate__fadeInUp animate__delay-2s">
        <h5>üïí Daily Routine</h5>
        <div class="progress-ring mx-auto mt-2">
          <svg width="100" height="100" data-percent="{{ routine_completion_percent }}">
            <circle class="bg" cx="50" cy="50" r="45"/>
            <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="282" stroke-dashoffset="282"/>
          </svg>
          <span class="progress-value">{{ routine_completion_percent }}%</span>
        </div>
        <p class="mt-2 small text-muted">{{ routine_completed_days }} of {{ total_days }} days</p>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-4">
    <div class="col-md-6 chart-card">
      <div class="card card-analytic p-3">
        <h5 class="mb-2">üíß Water Intake</h5>
        <p class="small text-muted">
          Goal: {{ water_goal_liters }} L ({{ water_goal_glasses }} glasses) | Avg: {{ average_water }} glasses
        </p>
        <canvas id="waterChart"></canvas>
      </div>
    </div>

    <div class="col-md-6 chart-card">
      <div class="card card-analytic p-3">
        <h5 class="mb-2">‚öñÔ∏è Weight Progress</h5>
        <p class="small text-muted">
          Start: {{ first_weight }} kg | Current: {{ last_weight }} kg |
          {% if weight_change > 0 %}
            <span class="text-success fw-bold">+{{ weight_change }} kg</span>
          {% elif weight_change < 0 %}
            <span class="text-danger fw-bold">{{ weight_change }} kg</span>
          {% else %}No Change{% endif %}
        </p>
        <canvas id="weightChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// üéØ Animate the ring progress dynamically
document.querySelectorAll('.progress-ring svg').forEach(svg => {
  const percent = parseFloat(svg.dataset.percent || 0);
  const circle = svg.querySelector('.progress');
  const radius = circle.r.baseVal.value;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference - (circumference * percent / 100);
  setTimeout(() => { circle.style.strokeDashoffset = offset; }, 300);
});

// üíß Water Chart
new Chart(document.getElementById('waterChart'), {
  type: 'bar',
  data: {
    labels: {{ water_chart.labels|safe }},
    datasets: [{
      label: 'Glasses',
      data: {{ water_chart.data|safe }},
      backgroundColor: 'rgba(77,171,247,0.6)',
      borderColor: '#4dabf7',
      borderWidth: 1,
      borderRadius: 8,
    }]
  },
  options: {
    plugins: { legend:{display:false}, title:{display:true,text:'Water Intake'} },
    scales: { y:{beginAtZero:true, suggestedMax: {{ water_goal_glasses|default:12 }} } }
  }
});

// ‚öñÔ∏è Weight Chart
new Chart(document.getElementById('weightChart'), {
  type: 'line',
  data: {
    labels: {{ weight_chart.labels|safe }},
    datasets: [{
      label: 'Weight (kg)',
      data: {{ weight_chart.data|safe }},
      borderColor: '#ff6b81',
      backgroundColor: 'rgba(255,107,129,0.2)',
      tension: 0.3,
      fill: true,
      pointRadius: 4,
      pointHoverRadius: 6
    }]
  },
  options: {
    plugins: { legend:{display:false}, title:{display:true,text:'Weight Trend'} },
    scales: { y:{beginAtZero:false} }
  }
});
</script>
{% endblock %}
