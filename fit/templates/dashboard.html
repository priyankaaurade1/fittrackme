{% extends "base.html" %}
{% block content %}
<style>
  .row.mb-4 > .col-md-4 {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .progress-wrapper {
    background: #f9f9f9;
    padding: 10px 15px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
  }

  .progress-label {
    font-weight: 600;
    margin-bottom: 5px;
    text-align: center;
    font-size: 1.1rem;
  }

  .custom-progress {
    height: 28px;
    background-color: #e0e0e0;
    border-radius: 20px;
    overflow: hidden;
  }

  .custom-bar {
    height: 100%;
    background: linear-gradient(90deg, #6dd5ed, #2193b0);
    transition: all 0.6s ease-in-out;
    color: white;
    font-weight: bold;
    text-align: center;
    line-height: 28px;
    font-size: 14px;
    border-radius: 20px;
  }

  input[type="checkbox"] {
    transform: scale(1.2);
    margin-right: 8px;
  }

  label {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }

  @media (max-width: 576px) {
    h2, h4 {
      font-size: 1.3rem;
    }

    .card-header {
      font-size: 1.1rem;
      text-align: center;
    }

    .form-label {
      font-size: 1rem;
    }

    .btn {
      font-size: 1rem;
    }

    .progress-label {
      font-size: 1rem;
    }

    .custom-progress {
      height: 24px;
    }

    .custom-bar {
      font-size: 12px;
      line-height: 24px;
    }

    .row-cols-4 > .col,
    .row-cols-6 > .col {
      flex: 0 0 33.3333%;
      max-width: 33.3333%;
    }
  }
  .badge {
  font-size: 0.9rem;
  border-radius: 12px;
  padding: 6px 10px;
}
  @media (max-width: 576px) {
  .form-check-label, label {
    font-size: 0.95rem;
  }

  input[type="checkbox"] {
    transform: scale(1.2);
    margin-right: 6px;
  }
}

</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% if next_routine_summary %}
<div class="alert alert-info shadow-sm p-3 mb-3 rounded-3 d-flex align-items-center justify-content-between">
  <div>
    <strong>ğŸ•“ Next:</strong> {{ next_routine_summary.title }}  
    <small class="text-muted">({{ next_routine_summary.time }})</small><br>
    <span class="fw-semibold">
      <span id="next-start-label">Starts in </span>
      <span id="next-start-countdown" data-start-ts="{{ next_routine_summary.start_ts }}">--</span>
    </span>
  </div>
  <span class="badge bg-primary px-3 py-2">Upcoming</span>
</div>
{% else %}
<div class="alert alert-secondary text-center fw-semibold shadow-sm rounded-3">
  ğŸ¯ No upcoming routine for today â€” great job!
</div>
{% endif %}

<div class="container mt-4">
  <h2 class="text-center mb-4 fs-4 fs-md-3">ğŸ“… Today's Plan â€“ {{ today|date:"l, j M Y" }}</h2>

  <div class="alert alert-primary text-center fw-bold shadow-sm rounded-3">
    ğŸš€ Keep going! Every checkbox is a step closer to your goal!
  </div>

  <div class="progress-wrapper mb-3">
    <div class="progress-label">
      ğŸ Progress: <span id="progressPercentText">{{ progress_percent }}%</span>
    </div>
    <div class="progress custom-progress">
      <div class="progress-bar custom-bar" role="progressbar"
           style="width: {{ progress_percent }}%;" 
           aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
        {{ progress_percent }}%
      </div>
    </div>
  </div>

  <form method="post">
    {% csrf_token %}

    <!-- âš–ï¸ Weight + BMI -->
    <div class="row mb-4">
      <div class="col-md-4 mb-3 mb-md-0">
        <label for="today_weight" class="form-label"><strong>âš–ï¸ Today's Weight (kg)</strong></label>
        <input type="number" step="0.01" name="today_weight" id="today_weight" class="form-control"
               value="{{ progress.today_weight|default_if_none:'' }}" placeholder="e.g., 60.5">
      </div>

      <input type="hidden" id="user_height" value="{{ user_height }}">
      <input type="hidden" id="yesterday_weight" value="{{ yesterday_weight }}">

      <div class="col-md-4 mb-3 mb-md-0">
        <p id="weightDiffDisplay" class="mb-1 mt-4">
          {% if not progress.today_weight %}
            <span style="color: gray;">âš–ï¸ Please enter your weight to start tracking.</span>
          {% elif yesterday_weight is None %}
            <span style="color: gray;">ğŸ“… Not enough data yet to compare with yesterday.</span>
          {% elif weight_diff > 0 %}
            <span style="color: green; font-weight: bold; font-size:x-large;">â†‘</span>
            Gained <strong>{{ weight_diff|floatformat:1 }}</strong> kg since yesterday
          {% elif weight_diff < 0 %}
            <span style="color: red; font-weight: bold; font-size:x-large;">â†“</span>
            Lost <strong>{{ weight_diff|floatformat:1 }}</strong> kg since yesterday
          {% else %}
            <span style="color: gray;">â†’</span> No change since yesterday
          {% endif %}
        </p>

        <p class="mb-1">
          <strong>ğŸ§® BMI:</strong>
          <span id="bmiValue" class="fw-bold animate__animated">{{ bmi|default:'--' }}</span>
        </p>
        <p id="motivationMsg" class="text-muted small">{{ motivation }}</p>
        <div id="bmiEmoji" class="fs-2 mt-1 text-center"></div>
      </div>
      <div class="col-md-4">
        <canvas id="weightChart" height="150"></canvas>
      </div>
    </div>

    <!-- â° Todayâ€™s Routine -->
    <div class="card mb-4">
      <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
        â° Today's Routine
        <small class="text-muted">Stay on track with your goals</small>
      </div>

      <div class="card-body" style="max-height: 280px; overflow-y: auto;">
        {% if today_routines %}
          <div class="list-group">
            {% for r in today_routines %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ r.title }}</strong>
                  <small class="text-muted d-block">{{ r.time }}</small>
                </div>

                <div class="d-flex align-items-center gap-2">
                  <input type="checkbox" name="routine_{{ r.id }}" class="routine-checkbox"
                    {% if r.is_done %}checked{% endif %}>

                  {% if not r.is_done %}
                    {% if r.status == "â° It's time!" %}
                      <span class="badge bg-danger">â° It's time!</span>
                    {% elif r.status %}
                      <!-- store absolute timestamp for JS -->
                      <span class="badge bg-warning text-dark countdown-timer"
                            data-start-ts="{{ r.start_ts }}">
                        â³ <span class="countdown-label">--</span>
                      </span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-success">âœ… Done</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No routines added for today yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- ğŸ½ï¸ Diet Plan -->
    <div class="card mb-4">
      <div class="card-header bg-light fw-bold">ğŸ½ï¸ Diet Plan</div>
      <div class="card-body">
        {% for meal, food_list in diet.items %}
        <strong>{{ meal }}</strong>
        <div class="row row-cols-2 row-cols-md-2 g-2 mb-3">
          {% for food in food_list %}
          <div class="col">
            <input type="checkbox" name="food_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" value="{{ food }}"
              id="food_{{ forloop.parentloop.counter }}_{{ forloop.counter }}"
              {% if food in progress.completed_foods %}checked{% endif %}>
            <label for="food_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">{{ food }}</label>
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ğŸ‹ï¸ Workout -->
    <div class="card mb-4">
      <div class="card-header bg-light fw-bold">ğŸ‹ï¸ Workout</div>
      <div class="card-body">
        <div class="row row-cols-2 row-cols-md-2 g-2 mb-3">
          {% for workout in workouts %}
          <div class="col">
            <input class="form-check-input" type="checkbox" name="workout_{{ forloop.counter }}"
                   id="workout_{{ forloop.counter }}" value="{{ workout }}"
                   {% if workout in progress.completed_workouts %}checked{% endif %}>
            <label class="form-check-label" for="workout_{{ forloop.counter }}">{{ workout }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ğŸ’§ Water Intake -->
    <div class="card mb-4">
      <div class="card-header bg-light fw-bold">ğŸ’§ Water Intake</div>
      <div class="card-body">
        <div class="row row-cols-4 row-cols-md-6 text-center">
          {% for i in water_unit_range %}
            <div class="col">
              <input type="checkbox" class="btn-check" name="water_{{ i }}" id="water_{{ i }}"
                    {% if i in progress.water_glasses %}checked{% endif %}>
              <label class="btn btn-outline-info w-100" for="water_{{ i }}">
                {% if i in progress.water_glasses %}
                  {% if water_type == "bottle" %}ğŸ§´{% else %}ğŸ¥›{% endif %}
                {% else %}
                  {% if water_type == "bottle" %}ğŸ¼{% else %}ğŸ§Š{% endif %}
                {% endif %}
              </label>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Sticky Save for Mobile -->
    <div class="sticky-bottom bg-white py-2 px-2 border-top d-md-none">
      <button type="submit" class="btn btn-success w-100 ">âœ… Save Progress</button>
    </div>

    <!-- Normal Save for Desktop -->
    <div class="d-none d-md-block">
      <button type="submit" class="btn btn-success w-100 mt-4 ">âœ… Save Progress</button>
    </div>
  </form>
</div>

<!-- JS for Chart, BMI, Progress, Water Emojis -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('weightChart').getContext('2d');
  const weightChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ labels|safe }},
      datasets: [{
        label: 'Weight (kg)',
        data: {{ weights|safe }},
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.3,
        fill: false,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });

  const weightInput = document.getElementById('today_weight');
  const height = parseFloat(document.getElementById('user_height').value);
  const yesterdayWeight = parseFloat(document.getElementById('yesterday_weight').value);
  const bmiDisplay = document.getElementById('bmiValue');
  const weightDiffDisplay = document.getElementById('weightDiffDisplay');
  const motivationMsg = document.getElementById('motivationMsg');
  const bmiEmoji = document.getElementById('bmiEmoji');

  // ğŸ¯ Animated BMI + Live Motivation
  function updateLiveCalculations() {
    const weight = parseFloat(weightInput.value);

    if (!isNaN(weight)) {
      // ğŸ§® Compute BMI
      if (!isNaN(height) && height > 0) {
        const bmi = weight / ((height / 100) ** 2);
        animateBMI(bmiDisplay, parseFloat(bmiDisplay.textContent) || 0, bmi, 800);
        updateMotivation(bmi);
      }

      // âš–ï¸ Weight difference
      if (!isNaN(yesterdayWeight)) {
        const diff = weight - yesterdayWeight;
        let diffText = '';

        if (diff > 0) {
          diffText = `<span style="color:green; font-weight: bold;">â†‘</span> Gained <strong>${diff.toFixed(1)}</strong> kg since yesterday`;
        } else if (diff < 0) {
          diffText = `<span style="color:red; font-weight: bold;">â†“</span> Lost <strong>${Math.abs(diff).toFixed(1)}</strong> kg since yesterday`;
        } else {
          diffText = `<span style="color:gray;">â†’</span> No change since yesterday`;
        }
        weightDiffDisplay.innerHTML = diffText;
      }
    } else {
      bmiDisplay.textContent = '--';
      motivationMsg.textContent = 'ğŸ Start by adding todayâ€™s weight to see your BMI and progress.';
      bmiEmoji.innerHTML = '';
      weightDiffDisplay.innerHTML = '<span style="color:gray;">âš–ï¸ Please enter your weight to start tracking.</span>';
    }
  }

  // ğŸ”¢ Smooth number animation
  function animateBMI(element, start, end, duration) {
    const startTime = performance.now();
    function animate(currentTime) {
      const progress = Math.min((currentTime - startTime) / duration, 1);
      const value = start + (end - start) * progress;
      element.textContent = value.toFixed(2);
      if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
    element.classList.add('animate__pulse');
    setTimeout(() => element.classList.remove('animate__pulse'), 800);
  }

  // ğŸ’¬ Smart motivation logic
  function updateMotivation(bmi) {
    let msg = '';
    let emoji = '';

    if (bmi < 18.5) {
      msg = "You're underweight. Letâ€™s build strength! ğŸ’ª";
      emoji = "ğŸ’ª";
    } else if (bmi < 25) {
      msg = "Healthy range! Keep it up! ğŸ¥—";
      emoji = "ğŸ¥—";
    } else if (bmi < 30) {
      msg = "Slightly overweight. Let's trim it down! ğŸƒ";
      emoji = "ğŸƒ";
    } else {
      msg = "Obese category. Take care of your health. â¤ï¸";
      emoji = "â¤ï¸";
    }

    motivationMsg.textContent = msg;
    bmiEmoji.innerHTML = `<span class="animate__animated animate__heartBeat">${emoji}</span>`;
  }

  weightInput.addEventListener('input', updateLiveCalculations);

  function updateProgressBar() {
    const all = document.querySelectorAll('input[type="checkbox"]');
    const checked = Array.from(all).filter(cb => cb.checked).length;
    const percent = Math.round((checked / all.length) * 100);

    const bar = document.querySelector('.custom-bar');
    const text = document.getElementById('progressPercentText');

    bar.style.width = percent + "%";
    bar.setAttribute("aria-valuenow", percent);
    bar.textContent = percent + "%";
    text.textContent = percent + "%";

    if (percent < 50) {
      bar.style.background = "linear-gradient(90deg, #ff6a6a, #ff4d4d)";
    } else if (percent < 80) {
      bar.style.background = "linear-gradient(90deg, #ffe259, #ffa751)";
    } else {
      bar.style.background = "linear-gradient(90deg, #38ef7d, #11998e)";
    }
  }

  document.querySelectorAll('input[type="checkbox"]').forEach(cb =>
    cb.addEventListener('change', updateProgressBar)
  );
  updateProgressBar();

  document.querySelectorAll('[id^="water_"]').forEach(el => {
    el.addEventListener('change', function () {
      const label = document.querySelector(`label[for="${this.id}"]`);
      const waterType = "{{ water_type }}";

      if (this.checked) {
        label.innerHTML = waterType === "bottle" ? "ğŸ§´" : "ğŸ¥›";
      } else {
        label.innerHTML = waterType === "bottle" ? "ğŸ¼" : "ğŸ§Š";
      }

      label.classList.add("animate__animated", "animate__bounceIn");
      setTimeout(() => label.classList.remove("animate__animated", "animate__bounceIn"), 1000);
    });
  });
</script>
<script>
  // ğŸŒ¸ Browser Notifications for Routine Reminders
document.addEventListener("DOMContentLoaded", () => {
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function showNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(title, { body: body, icon: "https://cdn-icons-png.flaticon.com/512/992/992700.png" });
    }
  }

  // â° Check for current routine
  const routines = JSON.parse('{{ today_routines|safe|escapejs }}');
  const now = new Date();

  routines.forEach(r => {
    const [hour, minute, period] = r.time.split(/[: ]/);
    let h = parseInt(hour);
    if (period === "PM" && h !== 12) h += 12;
    if (period === "AM" && h === 12) h = 0;
    const routineTime = new Date();
    routineTime.setHours(h, parseInt(minute), 0, 0);

    // Notify 2 minutes before
    const diff = (routineTime - now) / 1000 / 60;
    if (diff <= 2 && diff > 0) {
      showNotification("ğŸ”” " + r.title, r.description || "Time to start your routine!");
    }
  });
});

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Helper: format seconds -> "Hh Mm Ss" or "Mm Ss"
  function formatSeconds(totalSeconds) {
    if (totalSeconds <= 0) return "0s";
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    if (hours > 0) {
      return `${hours}h ${minutes}m ${seconds}s`;
    } else if (minutes > 0) {
      return `${minutes}m ${seconds}s`;
    } else {
      return `${seconds}s`;
    }
  }

  // Routine list countdowns
  const countdownBadges = document.querySelectorAll(".countdown-timer");
  const updateAll = () => {
    const now = Date.now();

    // update list badges
    countdownBadges.forEach(badge => {
      const startTs = parseInt(badge.dataset.startTs, 10);
      if (!startTs) return;

      const diffSec = Math.floor((startTs - now) / 1000);
      const label = badge.querySelector(".countdown-label");
      if (diffSec > 0) {
        label.textContent = formatSeconds(diffSec);
        // keep warning style
        badge.classList.remove("bg-danger");
        badge.classList.add("bg-warning", "text-dark");
      } else if (diffSec >= -30) {
        // within 30 seconds past start -> show "It's time!"
        badge.classList.remove("bg-warning", "text-dark");
        badge.classList.add("bg-danger");
        badge.textContent = "â° It's time!";
      } else {
        // past more than 30s and not checked -> hide badge (or show nothing)
        badge.style.display = "none";
      }
    });

    // update next routine summary
    const nextLabelEl = document.getElementById("next-start-countdown");
    if (nextLabelEl) {
      const startTs = parseInt(nextLabelEl.dataset.startTs, 10);
      if (startTs) {
        const diffSec = Math.floor((startTs - now) / 1000);
        if (diffSec > 0) {
          nextLabelEl.textContent = formatSeconds(diffSec);
        } else if (diffSec >= -30) {
          nextLabelEl.textContent = "â° It's time!";
        } else {
          nextLabelEl.textContent = "Started";
        }
      }
    }
  };

  // Run immediately and then every 1s for smooth ticking
  updateAll();
  setInterval(updateAll, 1000);
});
</script>
{% endblock %}
